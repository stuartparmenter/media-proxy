name: Update yt-dlp packages

on:
  schedule:
    # Run daily at 7 AM Pacific (after dependabot runs at 6 AM)
    - cron: '0 15 * * *'
  workflow_dispatch:

jobs:
  check-updates:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - uses: actions/checkout@v6

      - name: Install uv
        uses: astral-sh/setup-uv@v7

      - name: Set up Python
        run: uv python install 3.12

      - name: Get current versions from lock file
        id: current
        run: |
          # Extract current versions from uv.lock
          # The lock file format has name and version on consecutive lines after [[package]]
          YT_DLP_CURRENT=$(grep -A1 '^name = "yt-dlp"$' uv.lock | grep 'version' | sed 's/.*"\(.*\)"/\1/')
          YT_DLP_EJS_CURRENT=$(grep -A1 '^name = "yt-dlp-ejs"$' uv.lock | grep 'version' | sed 's/.*"\(.*\)"/\1/')

          echo "yt_dlp=$YT_DLP_CURRENT" >> $GITHUB_OUTPUT
          echo "yt_dlp_ejs=$YT_DLP_EJS_CURRENT" >> $GITHUB_OUTPUT
          echo "Current yt-dlp: $YT_DLP_CURRENT"
          echo "Current yt-dlp-ejs: $YT_DLP_EJS_CURRENT"

      - name: Check latest versions on PyPI
        id: latest
        run: |
          # Get latest versions from PyPI JSON API
          YT_DLP_LATEST=$(curl -s https://pypi.org/pypi/yt-dlp/json | jq -r '.info.version')
          YT_DLP_EJS_LATEST=$(curl -s https://pypi.org/pypi/yt-dlp-ejs/json | jq -r '.info.version')

          echo "yt_dlp=$YT_DLP_LATEST" >> $GITHUB_OUTPUT
          echo "yt_dlp_ejs=$YT_DLP_EJS_LATEST" >> $GITHUB_OUTPUT
          echo "Latest yt-dlp: $YT_DLP_LATEST"
          echo "Latest yt-dlp-ejs: $YT_DLP_EJS_LATEST"

      - name: Compare versions
        id: compare
        run: |
          NEEDS_UPDATE="false"
          UPDATE_SUMMARY=""

          if [ "${{ steps.current.outputs.yt_dlp }}" != "${{ steps.latest.outputs.yt_dlp }}" ]; then
            NEEDS_UPDATE="true"
            UPDATE_SUMMARY="yt-dlp: ${{ steps.current.outputs.yt_dlp }} -> ${{ steps.latest.outputs.yt_dlp }}"
            echo "yt-dlp needs update"
          fi

          if [ "${{ steps.current.outputs.yt_dlp_ejs }}" != "${{ steps.latest.outputs.yt_dlp_ejs }}" ]; then
            NEEDS_UPDATE="true"
            if [ -n "$UPDATE_SUMMARY" ]; then
              UPDATE_SUMMARY="$UPDATE_SUMMARY, yt-dlp-ejs: ${{ steps.current.outputs.yt_dlp_ejs }} -> ${{ steps.latest.outputs.yt_dlp_ejs }}"
            else
              UPDATE_SUMMARY="yt-dlp-ejs: ${{ steps.current.outputs.yt_dlp_ejs }} -> ${{ steps.latest.outputs.yt_dlp_ejs }}"
            fi
            echo "yt-dlp-ejs needs update"
          fi

          echo "needs_update=$NEEDS_UPDATE" >> $GITHUB_OUTPUT
          echo "summary=$UPDATE_SUMMARY" >> $GITHUB_OUTPUT

      - name: Update packages
        if: steps.compare.outputs.needs_update == 'true'
        run: |
          # Use uv to upgrade yt-dlp (this will also update yt-dlp-ejs as a transitive dep)
          uv lock --upgrade-package yt-dlp --upgrade-package yt-dlp-ejs

      - name: Create Pull Request
        if: steps.compare.outputs.needs_update == 'true'
        uses: peter-evans/create-pull-request@v8
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Bump ${{ steps.compare.outputs.summary }}"
          title: "Bump ${{ steps.compare.outputs.summary }}"
          body: |
            Updates yt-dlp packages to their latest versions.

            ## Changes
            - yt-dlp: `${{ steps.current.outputs.yt_dlp }}` -> `${{ steps.latest.outputs.yt_dlp }}`
            - yt-dlp-ejs: `${{ steps.current.outputs.yt_dlp_ejs }}` -> `${{ steps.latest.outputs.yt_dlp_ejs }}`

            ## Why this workflow exists
            Dependabot cannot properly detect updates for these packages because:
            1. `yt-dlp` uses extras syntax (`[default,curl-cffi]`) which can confuse dependency scanners
            2. `yt-dlp-ejs` is a transitive dependency (pulled in via `yt-dlp[default]`), not directly listed in `pyproject.toml`

            This automated workflow checks PyPI directly and creates PRs when updates are available.
          branch: automated/yt-dlp-update
          delete-branch: true
          labels: dependencies
